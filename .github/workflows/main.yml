name: GitFlow CI/CD

on:
  push:
    branches:
      - main
      - develop
      - "feature/**"
      - "release/**"
      - "hotfix/**"
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

concurrency:
  group: devops-sharing-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  COMPOSE_PROJECT_NAME: devops-sharing

jobs:
  build:
    name: Build (Docker images)
    runs-on: [self-hosted, Cloudflare]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Docker build (via Compose)
        run: |
          docker compose build
          docker compose images || true

  deploy:
    name: Deploy (Docker Compose on Cloudflare runner)
    needs: build
    if: ${{ github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/') || startsWith(github.ref, 'refs/heads/hotfix/') || github.event_name == 'workflow_dispatch' }}
    runs-on: [self-hosted, Cloudflare]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy with Docker Compose
        run: |
          docker compose up -d --build
          docker compose ps

      - name: Test after deploy (curl inside compose network)
        run: |
          set -e
          NET="${COMPOSE_PROJECT_NAME}_default"
          CURL_IMAGE="curlimages/curl:8.5.0"

          docker network inspect "$NET" >/dev/null 2>&1 || (echo "Missing docker network: $NET" && exit 1)

          echo "Waiting for backend /health on network $NET..."
          ok=0
          for i in $(seq 1 30); do
            if docker run --rm --network "$NET" "$CURL_IMAGE" -fsS http://backend:3001/health >/dev/null; then
              ok=1
              break
            fi
            sleep 2
          done
          if [ "$ok" -ne 1 ]; then
            echo "Backend healthcheck failed"
            docker compose ps || true
            docker compose logs --tail 200 backend || true
            exit 1
          fi

          docker run --rm --network "$NET" "$CURL_IMAGE" -fsS "http://backend:3001/api/hello?name=CloudflareRunner" >/dev/null
          docker run --rm --network "$NET" "$CURL_IMAGE" -fsS "http://backend:3001/api/info" >/dev/null
          docker run --rm --network "$NET" "$CURL_IMAGE" -fsS "http://frontend/" >/dev/null
